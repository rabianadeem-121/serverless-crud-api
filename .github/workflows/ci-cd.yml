name: CI/CD Node.js â†’ AWS Lambda + API Gateway

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  infra:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7

      - name: Terraform Init & Apply
        run: |
          cd terraform
          terraform init
          terraform apply -auto-approve

      - name: Save Terraform outputs
        id: tf
        run: |
          cd terraform
          echo "EC2_IP=$(terraform output -raw ec2_public_ip)" >> $GITHUB_ENV
          echo "RDS_ENDPOINT=$(terraform output -raw rds_endpoint)" >> $GITHUB_ENV

  test:
    needs: infra
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        run: docker build -t crud-api .

      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_KEY }}" > ec2_key.pem
          chmod 600 ec2_key.pem

      - name: Run tests in Docker with SSH tunnel to private RDS
        run: |
          docker run --rm \
            -e DB_HOST=127.0.0.1 \
            -e DB_USER=${{ secrets.DB_USER }} \
            -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
            -e DB_NAME=${{ secrets.DB_NAME }} \
            -e DB_PORT=${{ secrets.DB_PORT }} \
            -v $PWD/ec2_key.pem:/root/ec2_key.pem:ro \
            crud-api bash -c "
              echo 'Starting SSH tunnel to private RDS...'
              ssh -o StrictHostKeyChecking=no -i /root/ec2_key.pem -N -L 5432:$RDS_ENDPOINT:5432 ec2-user@$EC2_IP &
              # Wait until port is open
              for i in {1..15}; do nc -z 127.0.0.1 5432 && break; echo 'Waiting for SSH tunnel...'; sleep 2; done
              echo 'SSH tunnel ready. Running tests...'
              npm test
            "

  deploy:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Zip project
        run: zip -r function.zip .

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::011664843975:role/github-permissions
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: github-actions-deploy

      - name: Deploy Lambda with rollback
        run: |
          LAMBDA_NAME="${{ secrets.LAMBDA_FUNCTION_NAME }}"

          if aws lambda get-alias --function-name $LAMBDA_NAME --name prod; then
              PREV_VERSION=$(aws lambda get-alias --function-name $LAMBDA_NAME --name prod --query 'FunctionVersion' --output text)
          else
              CUR_VERSION=$(aws lambda publish-version --function-name $LAMBDA_NAME --query 'Version' --output text)
              aws lambda create-alias --function-name $LAMBDA_NAME --name prod --function-version $CUR_VERSION
              PREV_VERSION=$CUR_VERSION
          fi
          echo "Previous Lambda version: $PREV_VERSION"

          aws lambda update-function-code --function-name $LAMBDA_NAME --zip-file fileb://function.zip

          echo "Waiting for Lambda update to complete..."
          while true; do
              STATUS=$(aws lambda get-function --function-name $LAMBDA_NAME --query 'Configuration.LastUpdateStatus' --output text)
              echo "Lambda update status: $STATUS"
              if [ "$STATUS" == "Successful" ]; then break; 
              elif [ "$STATUS" == "Failed" ]; then echo "Lambda update failed"; exit 1; 
              else sleep 5; fi
          done

          NEW_VERSION=$(aws lambda publish-version --function-name $LAMBDA_NAME --query 'Version' --output text)
          aws lambda update-alias --function-name $LAMBDA_NAME --name prod --function-version $NEW_VERSION || \
          aws lambda update-alias --function-name $LAMBDA_NAME --name prod --function-version $PREV_VERSION

      - name: Deploy API Gateway
        run: |
          aws apigateway create-deployment \
            --rest-api-id ${{ secrets.API_ID }} \
            --stage-name ${{ secrets.STAGE_NAME }} \
            --description "Deployed via GitHub Actions"
